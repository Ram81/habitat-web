!function(e){var t={};function n(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(i,o,function(t){return e[t]}.bind(null,o));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=14)}([function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}e.exports=function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t,n){var i=n(5),o=n(6),s=n(7),r=n(9);e.exports=function(e,t){return i(e)||o(e,t)||s(e,t)||r()},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t){function n(t){return e.exports=n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,n(t)}e.exports=n,e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t){e.exports=function(e){if(Array.isArray(e))return e},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t){e.exports=function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,o,s=[],r=!0,a=!1;try{for(n=n.call(e);!(r=(i=n.next()).done)&&(s.push(i.value),!t||s.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==n.return||n.return()}finally{if(a)throw o}}return s}},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t,n){var i=n(8);e.exports=function(e,t){if(e){if("string"==typeof e)return i(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(e,t):void 0}},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t){e.exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,t,n){var i=n(11),o=n(12);"string"==typeof(o=o.__esModule?o.default:o)&&(o=[[e.i,o,""]]);var s={insert:"head",singleton:!1};i(o,s);e.exports=o.locals||{}},function(e,t,n){"use strict";var i,o=function(){return void 0===i&&(i=Boolean(window&&document&&document.all&&!window.atob)),i},s=function(){var e={};return function(t){if(void 0===e[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}e[t]=n}return e[t]}}(),r=[];function a(e){for(var t=-1,n=0;n<r.length;n++)if(r[n].identifier===e){t=n;break}return t}function c(e,t){for(var n={},i=[],o=0;o<e.length;o++){var s=e[o],c=t.base?s[0]+t.base:s[0],l=n[c]||0,u="".concat(c," ").concat(l);n[c]=l+1;var d=a(u),h={css:s[1],media:s[2],sourceMap:s[3]};-1!==d?(r[d].references++,r[d].updater(h)):r.push({identifier:u,updater:g(h,t),references:1}),i.push(u)}return i}function l(e){var t=document.createElement("style"),i=e.attributes||{};if(void 0===i.nonce){var o=n.nc;o&&(i.nonce=o)}if(Object.keys(i).forEach((function(e){t.setAttribute(e,i[e])})),"function"==typeof e.insert)e.insert(t);else{var r=s(e.insert||"head");if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(t)}return t}var u,d=(u=[],function(e,t){return u[e]=t,u.filter(Boolean).join("\n")});function h(e,t,n,i){var o=n?"":i.media?"@media ".concat(i.media," {").concat(i.css,"}"):i.css;if(e.styleSheet)e.styleSheet.cssText=d(t,o);else{var s=document.createTextNode(o),r=e.childNodes;r[t]&&e.removeChild(r[t]),r.length?e.insertBefore(s,r[t]):e.appendChild(s)}}function f(e,t,n){var i=n.css,o=n.media,s=n.sourceMap;if(o?e.setAttribute("media",o):e.removeAttribute("media"),s&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),e.styleSheet)e.styleSheet.cssText=i;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(i))}}var v=null,p=0;function g(e,t){var n,i,o;if(t.singleton){var s=p++;n=v||(v=l(t)),i=h.bind(null,n,s,!1),o=h.bind(null,n,s,!0)}else n=l(t),i=f.bind(null,n,t),o=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)};return i(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;i(e=t)}else o()}}e.exports=function(e,t){(t=t||{}).singleton||"boolean"==typeof t.singleton||(t.singleton=o());var n=c(e=e||[],t);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var i=0;i<n.length;i++){var o=a(n[i]);r[o].references--}for(var s=c(e,t),l=0;l<n.length;l++){var u=a(n[l]);0===r[u].references&&(r[u].updater(),r.splice(u,1))}n=s}}}},function(e,t,n){(t=n(13)(!1)).push([e.i,"/** Copyright (c) Facebook, Inc. and its affiliates.\n *  This source code is licensed under the MIT license found in the\n *  LICENSE file in the root directory of this source tree.\n */\n#radar {\n  position: absolute;\n  top: 70%;\n  left: 50%;\n  margin-left: -50px;\n  width: 100;\n  height: 100;\n  z-index: 9;\n  pointer-events: none;\n  visibility: hidden;\n}\n\n#scope {\n  position: absolute;\n  border-color: red;\n  border-style: dashed;\n  border-width: 5px;\n  opacity: 0.4;\n  top: 50%;\n  left: 50%;\n  margin-left: -160px;\n  margin-top: -120px;\n  width: 320px;\n  height: 240px;\n  z-index: 9;\n  pointer-events: none;\n}\n\n#fps {\n  text-align: right;\n  margin-left: auto;\n  margin-right: auto;\n  width: 800px;\n  font-size: 15pt;\n  font-family: monospace;\n}\n\n#warning {\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  z-index: 100;\n  background-color: #fff;\n  color: #000;\n}\n\n.hidden {\n  display: none !important;\n}\n\n.inventory-center {\n  margin-top: 1.5em;\n  text-align: center;\n}\n",""]),e.exports=t},function(e,t,n){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n=function(e,t){var n=e[1]||"",i=e[3];if(!i)return n;if(t&&"function"==typeof btoa){var o=(r=i,a=btoa(unescape(encodeURIComponent(JSON.stringify(r)))),c="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(a),"/*# ".concat(c," */")),s=i.sources.map((function(e){return"/*# sourceURL=".concat(i.sourceRoot||"").concat(e," */")}));return[n].concat(s).concat([o]).join("\n")}var r,a,c;return[n].join("\n")}(t,e);return t[2]?"@media ".concat(t[2]," {").concat(n,"}"):n})).join("")},t.i=function(e,n,i){"string"==typeof e&&(e=[[null,e,""]]);var o={};if(i)for(var s=0;s<this.length;s++){var r=this[s][0];null!=r&&(o[r]=!0)}for(var a=0;a<e.length;a++){var c=[].concat(e[a]);i&&o[c[0]]||(n&&(c[2]?c[2]="".concat(n," and ").concat(c[2]):c[2]=n),t.push(c))}},t}},function(e,t,n){"use strict";n.r(t);var i=n(0),o=n.n(i),s=n(1),r=n.n(s),a=n(3),c=n.n(a),l={height:.88,radius:.18,mass:32,linearAcceleration:20,angularAcceleration:4*Math.PI,linearFriction:.5,angularFriction:1,coefficientOfRestitution:0},u={startState:{position:[-4.94049,-2.63092,-7.57733],rotation:[0,.980792,0,.195056]},goal:{position:[2.2896811962127686,.11950381100177765,16.97636604309082]}},d={height:480,width:640},h=-1===window.location.href.indexOf("localhost")?"https://habitat-resources.s3.amazonaws.com/data/scene_datasets/habitat-test-scenes/skokloster-castle.glb":"skokloster-castle.glb",f=["cylinderSolid_rings_1_segments_12_halfLen_1_useTexCoords_false_useTangents_false_capEnds_true"],v=["B6ByNegPMKs.glb","kEZ7cmS4wCh.glb","dhjEzFoUFzH.glb","E9uDoFAP3SH.glb","vyrNrziPKCB.glb"],p={objectnav:{sensorConfig:{position:[0,.88,0]},actions:["moveForward","turnLeft","turnRight","lookUp","lookDown"],sliding:!1,actuationSpec:{move:.25,turn:30}},rearrangement:{sensorConfig:{position:[0,1.5,0]},actions:["moveForward","turnLeft","turnRight","lookUp","lookDown","moveBackward"],sliding:!0,actuationSpec:{move:.15,turn:5}}},g=n(2),y=n.n(g),b=n(4),m=n.n(b);function j(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return k(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return k(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return r=e.done,e},e:function(e){a=!0,s=e},f:function(){try{r||null==n.return||n.return()}finally{if(a)throw s}}}}function k(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function w(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=j(window.location.search.substr(1).split("&"));try{for(n.s();!(e=n.n()).done;){var i=e.value,o=i.split("="),s=y()(o,2),r=s[0],a=s[1];r&&a&&(t[r]=decodeURIComponent(a))}}catch(e){n.e(e)}finally{n.f()}return t}function O(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{encoding:"utf8"},n=FS.readFile(e,{encoding:t.encoding}),i=JSON.parse(n);return i}function S(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"task.json",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"0",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"pick_and_place",i=O(e),o={startState:{}};if("pick_and_place"==n)o.episodeID=t,o.startState.position=i.episodes[t].start_position,o.startState.rotation=i.episodes[t].start_rotation,o.sceneID=i.episodes[t].scene_id,o.objects=i.episodes[t].objects,o.task=i.episodes[t].task;else{var s=i.episodes[t].scene_id.split("/");o.episode_id=parseInt(i.episodes[t].episode_id),o.startState.position=i.episodes[t].start_position,o.startState.rotation=i.episodes[t].start_rotation,o.scene_id=i.episodes[t].scene_id,o.object_category=i.episodes[t].object_category;var r=s[s.length-1]+"_"+o.object_category;o.scene_dataset=i.episodes[t].scene_dataset,Object.keys(i.goals_by_category).includes(r)?o.goals=i.goals_by_category[r]:(o.is_thda=!0,o.goals=i.episodes[t].goals,o.scene_state=i.episodes[t].scene_state,i.goals_by_category=null),o.info=i.episodes[t].info,o.start_room=i.episodes[t].start_room,o.shortest_paths=i.episodes[t].shortest_paths,o.task={instruction:"Find and go to "+o.object_category,type:"objectnav"}}return o}function I(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"0",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"pick_and_place";return void 0===e?u:void 0===t?S(e):S(e,t,n)}function A(e,t){var n=window.location.protocol+"//"+window.location.host+"/"+e;console.log("scene config: "+e),console.log("get meta: "+n);var i=new XMLHttpRequest;if(i.open("GET",n,!1),i.send(null),200==i.status){var o=JSON.parse(i.response),s=o.episodes[t];return null==s&&(s=o.episodes[0]),s}return null}function T(e,t){var n=t.split(".")[0];return{object:e,objectIcon:"/data/test_assets/objects/"+n+".png",objectHandle:"/data/objects/"+t,physicsProperties:"test_assets/objects/"+t,renderMesh:"test_assets/objects/"+n+".glb"}}var C=function(){function e(t){o()(this,e),this.psiturk=t}return r()(e,[{key:"handleRecordTrialData",value:function(e,t,n){this.psiturk&&0==window.config.disableLogging&&this.psiturk.recordTrialData({phase:e,event:t,data:n})}},{key:"handleRecordUnstructuredData",value:function(e,t){this.psiturk&&0==window.config.disableLogging&&this.psiturk.recordUnstructuredData(e,t)}}]),e}();function M(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return _(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return r=e.done,e},e:function(e){a=!0,s=e},f:function(){try{r||null==n.return||n.return()}finally{if(a)throw s}}}}function _(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var x=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;o()(this,e),v.includes(t.scene_id)&&(t.textureDownsampleFactor=1),this.sim=new Module.Simulator(t),this.pathfinder=this.sim.getPathFinder(),this.psiturk=new C(window.psiTurk),this.resolution=null,this.grippedObjectId=-1,this.nearestObjectId=-1,this.gripOffset=null,this.selectedAgentId=i,this.agentObjectHandle=f[0],this.setEpisode(n),this.maxDistance=2,this.objectIndexx=108,this.islandRadiusLimit=1.8,this.recomputeNavMesh(),this.locobot_id=-1}return r()(e,[{key:"reset",value:function(){(this.sim.reset(),null!==this.initialAgentState)&&this.sim.getAgent(this.selectedAgentId).setState(this.initialAgentState,!0);this.grippedObjectId=-1,this.nearestObjectId=-1,this.gripOffset=null,this.psiturk.handleRecordTrialData("TEST","simReset",{})}},{key:"changeAgent",value:function(e){this.selectedAgentId=e}},{key:"setEpisode",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.removeAllObjects(),this.episode=e,this.initialAgentState=null,this.objectsInScene=[],this.initialize_THDA_episode(e),Object.keys(e).length>0){if(this.initialAgentState=this.createAgentState(e.startState),this.sim.addContactTestObject(this.agentObjectHandle,0),void 0!==e.objects){var t=JSON.parse(JSON.stringify(e.objects));for(var n in t.sort((function(e,t){var n=e.objectId,i=t.objectId;return n<i?-1:n>i?1:0})),t){var i=t[n].objectHandle,o=this.convertVec3fToVector3(t[n].position),s=this.quatFromCoeffs(t[n].rotation),r=this.addObjectAtLocation(i,o,s,Module.MotionType.DYNAMIC);this.addObjectInScene(r,t[n]),this.sim.addContactTestObject(i,0),e.objects[n].simObjectId=r,e.objects[n].prevObjectId=e.objects[n].objectId,e.objects[n].objectId=r}}}else this.sim.addContactTestObject(this.agentObjectHandle,0);var a=JSON.parse(JSON.stringify(e));"objectnav"==window.config.dataset&&1!=e.is_thda&&(a.goals=[]),this.psiturk.handleRecordTrialData("TEST","setEpisode",{episode:a})}},{key:"initialize_THDA_episode",value:function(e){var t=e.scene_state;if(void 0!==t){var n=t.objects;for(var i in n){var o=n[i],s=o.object_template.split("/"),r="/data/objects/"+s[s.length-1]+".object_config.json",a=this.convertVec3fToVector3(o.position),c=this.quatFromCoeffs(o.rotation);this.addObjectAtLocation(r,a,c,Module.MotionType.STATIC)}this.recomputeNavMesh()}}},{key:"updateCrossHairNode",value:function(e){this.sim.updateCrossHairNode(e)}},{key:"addObjectInScene",value:function(e,t){var n=JSON.parse(JSON.stringify(t));n.objectId=e,this.objectsInScene.push(n)}},{key:"updateObjectInScene",value:function(e,t){for(var n=0;n<this.objectsInScene.length;n++)if(this.objectsInScene[n].objectId==e){this.objectsInScene[n].objectId=t;break}}},{key:"getObjectFromScene",value:function(e){for(var t=0;t<this.objectsInScene.length;t++)if(this.objectsInScene[t].objectId==e)return this.objectsInScene[t];return null}},{key:"getObjectsInScene",value:function(){return this.objectsInScene}},{key:"syncObjects",value:function(){this.sim.syncGrippedObject(this.grippedObjectId)}},{key:"addObjectAtLocation",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Module.MotionType.STATIC,o=this.addObjectByHandle(e);return this.setTranslation(t,o,0),this.setRotation(n,o,0),this.setObjectMotionType(i,o,0),o}},{key:"removeAllObjects",value:function(){for(var e=this.getExistingObjectIDs(),t=e.size()-1;t>=0;t--){var n=e.get(t),i=this.getObjectFromScene(n);this.removeObject(n),"objectnav"!=window.config.dataset&&this.sim.removeContactTestObject(i.objectHandle,0)}this.sim.clearRecycledObjectIds()}},{key:"step",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.sim.getAgent(this.selectedAgentId);if(t){var i=this.getAgentTransformation(this.selectedAgentId),o=this.isAgentColliding(e,i);if(o.collision)return!0}return n.act(e),!1}},{key:"addAgent",value:function(e){var t=this.createAgentConfig(e);return this.resolution=this.flipVec2i(t.sensorSpecifications.get(0).resolution),this.sim.addAgent(t)}},{key:"addObject",value:function(e){return this.sim.addObject(e,null,"",0)}},{key:"removeObject",value:function(e){this.sim.removeObject(e,!0,!0,0)}},{key:"addObjectByHandle",value:function(e){return this.sim.addObjectByHandle(e,null,"",0)}},{key:"addPrimitiveObject",value:function(){var e=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5;return Math.floor(Math.random()*e)}(f.length),t=f[e],n=this.addObjectByHandle(t),i=this.getAgentTransformation(0).transformPoint(new Module.Vector3(.1,1.5,-1.5));return this.setTranslation(i,n,0),n}},{key:"addTemplateObject",value:function(){var e=this.objectIndexx,t=(void 0).objects[e].objectHandle,n=this.addObjectByHandle(t),i=this.getAgentTransformation(0).transformPoint(new Module.Vector3(.1,1.5,-1.5));return this.setTranslation(i,n,0),(void 0).objects[e].isReceptacle=!1,this.addObjectInScene(n,(void 0).objects[e]),this.sim.addContactTestObject((void 0).objects[e].objectHandle,0),this.objectIndexx+=1,n}},{key:"removeLastObject",value:function(){var e=this.getExistingObjectIDs();e.size()>0&&this.removeObject(e.get(e.size()-1))}},{key:"grabReleaseObject",value:function(){var e=this.getObjectUnderCrosshair(),t=this.getAgentTransformation(0);if(-1!=this.grippedObjectId){this.setTransformation(t.mul(this.gripOffset),this.grippedObjectId,0);var n=this.getTranslation(this.grippedObjectId,0);if(!this.pathfinder.isNavigable(this.convertVector3ToVec3f(n),.5))return void console.log("Colliding with object or position is not navigable");this.setObjectMotionType(Module.MotionType.STATIC,this.grippedObjectId,0),this.grippedObjectId=-1,this.drawBBAroundNearestObject()}else{if(-1==e)return;this.gripOffset=t.inverted().mul(this.getTransformation(e,0)),this.setObjectMotionType(Module.MotionType.KINEMATIC,e,0),this.grippedObjectId=e}this.recomputeNavMesh()}},{key:"inventoryGrabReleaseObject",value:function(){var e=this.getObjectUnderCrosshair().nearestObjectId,t=!1,n=!1,i={};if(-1!=this.grippedObjectId){n=!0;var o=this.findObjectFloorPositionUnderCrosshair(),s=o.newObjectPosition;if(o.collision)return{actionFailed:!0};var r=this.getObjectFromScene(this.grippedObjectId),a=this.addObjectByHandle(r.objectHandle);this.setTranslation(s,a,0),this.setObjectMotionType(Module.MotionType.DYNAMIC,a,0),this.updateObjectInScene(this.grippedObjectId,a),i={newObjectTranslation:this.convertVector3ToVec3f(s),newObjectId:a,objectHandle:r.objectHandle,grippedObjectId:this.grippedObjectId},this.grippedObjectId=-1}else if(-1!=e){t=!0,this.grippedObjectTransformation=this.getTransformation(e,0),!0!==this.getObjectFromScene(e).isReceptacle&&(this.removeObject(e,0),this.grippedObjectId=e),i={grippedObjectId:this.grippedObjectId}}return{grabAction:t,releaseAction:n,objectUnderCrosshair:e,grippedObjectId:this.grippedObjectId,nearestObjectId:this.nearestObjectId,actionMeta:i}}},{key:"getObservationSpace",value:function(e){return this.sim.getAgentObservationSpace(this.selectedAgentId,e)}},{key:"getObservation",value:function(e,t){return this.sim.getAgentObservation(this.selectedAgentId,e,t),t}},{key:"getPathFinder",value:function(){return this.sim.getPathFinder()}},{key:"getObjectMotionType",value:function(e,t){return this.sim.getObjectMotionType(e,t)}},{key:"setObjectMotionType",value:function(e,t,n){return this.sim.setObjectMotionType(e,t,n)}},{key:"getExistingObjectIDs",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.sim.getExistingObjectIDs(e)}},{key:"setTransformation",value:function(e,t,n){this.sim.setTransformation(e,t,n)}},{key:"getTransformation",value:function(e,t){return this.sim.getTransformation(e,t)}},{key:"getTranslation",value:function(e,t){return this.sim.getTranslation(e,t)}},{key:"setTranslation",value:function(e,t,n){this.sim.setTranslation(e,t,n)}},{key:"getRotation",value:function(e,t){return this.sim.getRotation(e,t)}},{key:"setRotation",value:function(e,t,n){this.sim.setRotation(e,t,n)}},{key:"setObjectBBDraw",value:function(e,t,n){this.sim.setObjectBBDraw(e,t,n)}},{key:"stepWorld",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/60;return this.sim.stepWorld(e)}},{key:"getWorldTime",value:function(){return this.sim.getWorldTime()}},{key:"displayObservation",value:function(e){this.sim.displayObservation(0,e)}},{key:"getSemanticScene",value:function(){return this.sim.getSemanticScene()}},{key:"contactTest",value:function(e){return this.sim.contactTest(e,0)}},{key:"getAgent",value:function(e){return this.sim.getAgent(e)}},{key:"getAgentTransformation",value:function(e){return this.sim.getAgentTransformation(e)}},{key:"getAgentAbsoluteTranslation",value:function(e){return this.sim.getAgentAbsoluteTranslation(e)}},{key:"getAgentRotation",value:function(e){return this.sim.getAgentRotation(e)}},{key:"getAgentSensorSuite",value:function(e){return this.sim.getAgentSensorSuite(e)}},{key:"getAgentState",value:function(){var e=new Module.AgentState;return this.sim.getAgent(this.selectedAgentId).getState(e),e}},{key:"getCrosshairPosition",value:function(){return this.resolution.map((function(e){return.5*e}))}},{key:"getObjectUnderCrosshair",value:function(){var e=this.getCrosshairPosition(),t=this.unproject(e).direction,n=this.getAgentAbsoluteTranslation(0);return{nearestObjectId:this.findNearestObjectUnderCrosshair(t,n,this.resolution),crossHairPoint:this.convertVector3ToVec3f(t),refPoint:this.convertVector3ToVec3f(n),crossHairPosition:e}}},{key:"drawBBAroundNearestObject",value:function(){var e=this.getObjectUnderCrosshair().nearestObjectId;if(-1==e)-1!=this.nearestObjectId&&this.grippedObjectId!=this.nearestObjectId&&(this.setObjectBBDraw(!1,this.nearestObjectId,0),this.nearestObjectId=e);else{if(-1!=this.nearestObjectId&&this.grippedObjectId!=this.nearestObjectId&&(this.setObjectBBDraw(!1,this.nearestObjectId,0),this.nearestObjectId=-1),!0===this.getObjectFromScene(e).isReceptacle)return;this.nearestObjectId!=e&&(this.nearestObjectId=e,this.setObjectBBDraw(!0,this.nearestObjectId,0))}}},{key:"showDropPoint",value:function(){if(-1===this.grippedObjectId){var e=this.getAgentAbsoluteTranslation(0);e=new Module.Vector3(e.x(),e.y()-.5,e.z()),this.updateDropPointNode(e)}else{var t=this.findObjectFloorPositionUnderCrosshair().newObjectPosition;this.updateDropPointNode(t)}}},{key:"updateDropPointNode",value:function(e){this.sim.updateDropPointNode(e)}},{key:"findObjectFloorPositionUnderCrosshair",value:function(){var e=this.getCrosshairPosition(),t=this.unproject(e).direction,n=this.getAgentTransformation(0),i=this.sim.findFloorPositionUnderCrosshair(t,n,this.resolution,this.maxDistance).point;if(null==i)return!0;for(var o=new Module.Vector3(i.x(),i.y(),i.z()),s=this.getObjectFromScene(this.grippedObjectId),r=this.isCollision(s.objectHandle,o),a=0;r&&a<2;)o=new Module.Vector3(o.x(),o.y()+.25,o.z()),r=this.isCollision(s.objectHandle,o),a+=1;var c=this.pathfinder.snapPoint(o);c=this.convertVector3ToVec3f(c);var l=this.pathfinder.islandRadius(c)<this.islandRadiusLimit,u=Math.abs(n.translation().y()-o.y());return{newObjectPosition:o,collision:r||l||u>1.6}}},{key:"sampleObjectState",value:function(e,t){this.sim.sampleObjectState(e,t)}},{key:"recomputeNavMesh",value:function(){var e=new Module.NavMeshSettings;e.agentRadius=l.radius,e.agentHeight=l.height,this.sim.recomputeNavMesh(this.getPathFinder(),e,!0)}},{key:"toggleNavMeshVisualization",value:function(){this.sim.setNavMeshVisualization(!0)}},{key:"findNearestObjectUnderCrosshair",value:function(e,t,n){return this.sim.findNearestObjectUnderCrosshair(e,t,n,this.maxDistance)}},{key:"unproject",value:function(e){return this.sim.unproject(e)}},{key:"isAgentColliding",value:function(e,t){if("moveForward"==e){var n=t.backward().mul(-.15),i=t.translation().add(n),o=this.pathfinder.tryStep(t.translation(),i).sub(i),s=!1,r=[0,.05,-.05,.1,-.1,-.2];for(var a in r){var c=r[a],l=i.add(o).add(new Module.Vector3(0,c,0));this.isCollision(this.agentObjectHandle,l,!0)&&(s=!0)}return{collision:s}}if("moveBackward"==e){var u=t.backward().mul(.15),d=t.translation().add(u),h=this.pathfinder.tryStep(t.translation(),d).sub(d),f=!1,v=[0,.05,-.05,.1,-.1,-.2];for(var p in v){var g=v[p],y=d.add(h).add(new Module.Vector3(0,g,0));this.isCollision(this.agentObjectHandle,y,!0)&&(f=!0)}return{collision:f}}return!1}},{key:"isCollision",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=1,s=-1;return n&&(s=1),this.sim.preAddContactTest(e,t,n,o,s,i)}},{key:"geodesicDistance",value:function(e,t){var n=new Module.ShortestPath;return n.requestedStart=e,n.requestedEnd=t,this.pathfinder.findPath(n),n.geodesicDistance}},{key:"getDistanceBetweenObjects",value:function(e,t){var n=this.getTranslation(e,0),i=this.getTranslation(t,0);return this.geodesicDistance(this.convertVector3ToVec3f(n),this.convertVector3ToVec3f(i))}},{key:"getObjectBBYCoord",value:function(e){return this.sim.getObjectBBYCoord(e)}},{key:"getNumActiveContactPoints",value:function(){return this.sim.getNumActiveContactPoints()}},{key:"getSceneBB",value:function(){return this.sim.getSceneBB()}},{key:"getObjectStates",value:function(){for(var e=[],t=this.getExistingObjectIDs(),n=0;n<t.size();n++){var i=t.get(n),o=this.getTranslation(i,0),s=this.getRotation(i,0),r=this.getObjectMotionType(i,0).value,a=this.getObjectFromScene(i),c={objectId:i,translation:this.convertVector3ToVec3f(o),rotation:this.coeffFromQuat(s),motionType:r,objectHandle:a.objectHandle};e.push(c)}return e}},{key:"getAgentPose",value:function(){for(var e=this.getAgentTransformation(this.selectedAgentId).translation(),t=this.getAgentRotation(this.selectedAgentId),n=this.getAgentSensorSuite(this.selectedAgentId),i=n.keys(),o={},s=0;s<i.size();s++){var r=i.get(s),a=n.get(r).rotation(),c=n.get(r).translation();o[r]={rotation:this.coeffFromQuat(a),position:this.convertVector3ToVec3f(c)}}return{position:this.convertVector3ToVec3f(e),rotation:this.coeffFromQuat(t),sensorData:o}}},{key:"getObjectPose",value:function(){var e=this.getObjectUnderCrosshair().nearestObjectId,t=this.getTranslation(e,0),n=this.getRotation(e,0);console.log("object translation: "+this.convertVector3ToVec3f(t)),console.log("object rotation: "+this.coeffFromQuat(n))}},{key:"convertVector3ToVec3f",value:function(e){return[e.x(),e.y(),e.z()]}},{key:"convertVec3fToVector3",value:function(e){return new Module.Vector3(e[0],e[1],e[2])}},{key:"coeffFromQuat",value:function(e){var t=this.convertVector3ToVec3f(e.vector()).slice();return t.push(e.scalar()),t}},{key:"quatFromCoeffs",value:function(e){var t=this.convertVec3fToVector3(e.slice(0,3));return new Module.Quaternion(t,e[3])}},{key:"flipVec2i",value:function(e){return[e[1],e[0]]}},{key:"euclideanDistance",value:function(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[2]-t[2],2)+Math.pow(e[1]-t[1],2))}},{key:"enableDebugDraw",value:function(){this.sim.enableDebugDraw()}},{key:"distanceToGoal",value:function(){if(0===Object.keys(this.episode).length||void 0===this.episode.goal)return[0,0];var e=this.episode.goal.position,t=this.getAgentState(),n=t.position,i=[e[0]-n[0],e[1]-n[1],e[2]-n[2]];return i=this.applyRotation(i,t.rotation),this.cartesian_to_polar(-i[2],i[0])}},{key:"applyRotation",value:function(e,t){var n,i,o,s,r,a,c,l=y()(e,3);n=l[0],i=l[1],o=l[2];var u=y()(t,4);s=u[0],r=u[1],a=u[2];var d=(c=u[3])*n-r*o+a*i,h=c*i-a*n+s*o,f=c*o-s*i+r*n,v=s*n+r*i+a*o,p=[];return p[0]=d*c+v*s+h*a-f*r,p[1]=h*c+v*r+f*s-d*a,p[2]=f*c+v*a+d*r-h*s,p}},{key:"cartesian_to_polar",value:function(e,t){return[Math.sqrt(e*e+t*t),Math.atan2(t,e)]}},{key:"createSensorSpec",value:function(e){var t=new Module.SensorSpec;for(var n in e){var i=e[n];t[n]=i}return t}},{key:"createAgentConfig",value:function(e){var t=new Module.AgentConfiguration;for(var n in e){var i=e[n];if("sensorSpecifications"===n){var o,s=new Module.VectorSensorSpec,r=M(i);try{for(r.s();!(o=r.n()).done;){var a=o.value;s.push_back(this.createSensorSpec(a))}}catch(e){r.e(e)}finally{r.f()}i=s}t[n]=i}return t}},{key:"createAgentState",value:function(e){var t=new Module.AgentState;for(var n in e){var i=e[n];t[n]=i}return t}}]),e}(),P=function(){function e(t,n){o()(this,e),this.episode=t,this.sim=n,this.task=this.episode.task}return r()(e,[{key:"validate",value:function(){return void 0===this.task||("arrangement"===this.task.type?this.validateArrangementTask():"cleaning"===this.task.type?this.validateCleaningTask():"objectnav"==this.task.type?1==this.episode.is_thda?this.validateObjectNavTHDATask():this.validateObjectNavTask():void 0)}},{key:"validateArrangementTask",value:function(){var e=this.task.goals;if(void 0===e||void 0===e.objectToReceptacleMap)return!0;if(-1!=this.sim.grippedObjectId)return!1;var t=e.objectToReceptacleMap,n=this.sim.getObjectsInScene(),i=!1,o=this.sim.episode.objects;for(var s in o){var r=o[s].objectId,a=o[s].position,c=this.sim.convertVector3ToVec3f(this.sim.getTranslation(r,0));this.sim.geodesicDistance(a,c)>0&&(i=!0)}for(var l in t){for(var u=n[parseInt(l)].objectId,d=this.sim.convertVector3ToVec3f(this.sim.getTranslation(u,0)),h=t[l],f=!1,v=0;v<h.length;v++){var p=n[h[v]].objectId,g=this.sim.convertVector3ToVec3f(this.sim.getTranslation(p,0)),y=this.sim.geodesicDistance(d,g),b=g[1]+this.sim.getObjectBBYCoord(p);y<=.7&&d[1]>b&&(f=!0)}if(!f)return!1}return i}},{key:"validateObjectNavTask",value:function(){var e=this.episode.goals;if(void 0===e)return!0;var t=!1;for(var n in e){var i=this.episode.goals[n];for(var o in i.view_points){var s=i.view_points[o].agent_state.position,r=this.sim.getAgentTransformation(this.sim.selectedAgentId),a=this.sim.convertVector3ToVec3f(r.translation());this.sim.geodesicDistance(a,s)<.1&&(t=!0)}}return t}},{key:"validateObjectNavTHDATask",value:function(){var e=this.episode.goals;if(void 0===e)return!0;var t=!1;for(var n in e){var i=this.episode.goals[n].position,o=this.sim.getAgentTransformation(this.sim.selectedAgentId),s=this.sim.convertVector3ToVec3f(o.translation());this.sim.euclideanDistance(s,i)<1&&(t=!0)}return t}},{key:"validateCleaningTask",value:function(){if(void 0===this.task.goals)return!0;if(-1!=this.sim.grippedObjectId)return!1;var e=!1,t=0,n=0,i=this.sim.episode.objects;for(var o in i){var s=i[o].objectId,r=i[o].position,a=this.sim.convertVector3ToVec3f(this.sim.getTranslation(s,0));this.sim.geodesicDistance(r,a)>.2&&(e=!0,n+=1),Math.abs(r[1]-a[1])>.2&&(t+=1)}return console.log("Num moved: "+n+" lifted: "+t+"  --- "+e),(n>=4||t>=4)&&e}}]),e}();function V(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return R(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return R(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return r=e.done,e},e:function(e){a=!0,s=e},f:function(){try{r||null==n.return||n.return()}finally{if(a)throw s}}}}function R(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var F=function(){function e(t,n){o()(this,e),this.sim=t,this.components=n,this.keyBindListener=null,this.taskValidator=null,this.components.taskValidator&&(this.taskValidator=this.components.taskValidator),this.psiturk=new C(window.psiTurk),this.actions=[{name:"moveForward",key:"w",keyCode:87},{name:"turnLeft",key:"ArrowLeft",keyCode:37},{name:"turnRight",key:"ArrowRight",keyCode:39},{name:"turnLeft",key:"a",keyCode:65},{name:"turnRight",key:"d",keyCode:68},{name:"lookUp",key:"ArrowUp",keyCode:38},{name:"lookDown",key:"ArrowDown",keyCode:40}]}return r()(e,[{key:"init",value:function(){this.bindKeys(),this.psiturk.handleRecordTrialData("TEST","simInitialized",{config:window.config}),this.initialized=!0,this.initRendering()}},{key:"initRendering",value:function(){var e=this;this.activeActions=[],this.activeActionIdx=0,this.frameCounter=0,this.frameRate=7,!0!==window.config.runFlythrough&&(console.log("enabled rendering step at 100ms interval"),this.renderingFunction=setInterval((function(){var t=e.popAction();e.handleAction(t),e.render(),e.frameCounter+=1}),1e3/this.frameRate))}},{key:"disableRendering",value:function(){this.renderingFunction&&(console.log("clearing rendering interval on reset"),window.clearInterval(this.renderingFunction))}},{key:"reset",value:function(){this.disableRendering(),this.sim.reset(),this.setStatus("Ready"),this.initRendering(),this.render()}},{key:"setTaskValidator",value:function(e){this.taskValidator=new P(e,this.sim)}},{key:"setStatus",value:function(e){this.components.status.style="color:white",this.components.status.innerHTML=e}},{key:"setErrorStatus",value:function(e){this.components.status.style="color:red",this.components.status.innerHTML=e}},{key:"setWarningStatus",value:function(e){this.components.status.style="color:orange",this.components.status.innerHTML=e}},{key:"setSuccessStatus",value:function(e){this.components.status.style="color:green",this.components.status.innerHTML=e}},{key:"renderImage",value:function(){this.sim.displayObservation("rgb")}},{key:"render",value:function(){this.renderImage(),this.renderImage()}},{key:"validateTask",value:function(){return!window.config.runFlythrough&&this.taskValidator.validate()}},{key:"pushAction",value:function(e){0==this.activeActions.length&&this.activeActions.push(e)}},{key:"popAction",value:function(){return this.activeActions.length>0?(this.activeActionIdx=0,this.activeActions[this.activeActionIdx]):"noOp"}},{key:"handleAction",value:function(e){var t=this.sim.step(e),n={action:e,agentState:this.sim.getAgentPose(),collision:t};this.psiturk.handleRecordTrialData("TEST","handleAction",n)}},{key:"removeActiveAction",value:function(e){var t=this.activeActions.indexOf(e);t>-1&&this.activeActions.splice(t,1)}},{key:"handleKeypressUp",value:function(e){var t,n=V(this.actions);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(i.keyCode===e){this.removeActiveAction(i.name);break}}}catch(e){n.e(e)}finally{n.f()}}},{key:"handleKeypress",value:function(e){var t,n=V(this.actions);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(i.keyCode===e){this.pushAction(i.name);break}}}catch(e){n.e(e)}finally{n.f()}}},{key:"bindKeys",value:function(){var e=this;e.keyBindListener?console.log("Keys already bound. Returning"):(e.keyBindListener=function(t){t.preventDefault(),e.handleKeypress(t.keyCode)},document.addEventListener("keydown",e.keyBindListener,!0),e.keyBindListener2=function(t){t.preventDefault(),e.handleKeypressUp(t.keyCode)},document.addEventListener("keyup",e.keyBindListener2,!0))}},{key:"unbindKeys",value:function(){this.keyBindListener&&(document.removeEventListener("keydown",this.keyBindListener,!0),this.keyBindListener=null,document.removeEventListener("keyup",this.keyBindListener2,!0),this.keyBindListener2=null)}}]),e}(),E=function(){function e(t){o()(this,e),this.inventorySlots=t,this.inventory=new Array(t),this.inventoryComponent=null,this.inventoryEnabled=!1,this.inventoryCtx=null}return r()(e,[{key:"reset",value:function(){this.inventory=new Array(this.inventorySlots)}},{key:"initInventory",value:function(e){this.inventoryComponent=e,this.inventoryEnabled=!0,this.inventoryCtx=e.getContext("2d")}},{key:"setSlot",value:function(e,t){this.inventory[e]=t}},{key:"getSlot",value:function(e){return this.inventory[e]}},{key:"getEmptySlot",value:function(){for(var e=0;e<this.inventorySlots;e++)if(void 0===this.inventory[e])return e;return-1}},{key:"findObjectSlot",value:function(e){for(var t=0;t<this.inventorySlots;t++)if(void 0!==this.inventory[t]&&this.inventory[t].objectId===e)return t;return-1}},{key:"renderInventory",value:function(){var e=this;if(this.inventoryEnabled){var t=80*this.inventorySlots;""===this.inventoryComponent.style.border&&(this.inventoryComponent.style.border="5px solid #000000",this.inventoryComponent.width=t.toString());var n=this.inventoryCtx;n.clearRect(0,0,t,80),n.fillStyle="darkslategray";for(var i=function(t){var i=2+78*t;n.beginPath(),n.strokeStyle="grey",n.lineWidth=5,n.rect(i,2,76,76),n.stroke(),n.closePath();if(void 0!==e.inventory[t]){var o=new Image;o.src=e.inventory[t].objectIcon,o.addEventListener("load",(function(){n.drawImage(o,i+2,4,72,72)}))}},o=0;o<this.inventorySlots;++o)i(o)}}}]),e}();function L(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return B(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return B(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return r=e.done,e},e:function(e){a=!0,s=e},f:function(){try{r||null==n.return||n.return()}finally{if(a)throw s}}}}function B(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var D=function(){function e(t,n){o()(this,e),this.sim=t,this.components=n,this.keyBindListener=null,this.lastInteractedObjectId=-1,this.inventory=new E(1),this.taskValidator=null,this.inventory.initInventory(n.inventory),this.components.taskValidator&&(this.taskValidator=this.components.taskValidator),this.psiturk=new C(window.psiTurk),this.actions=[{name:"moveForward",key:"w",keyCode:87},{name:"moveBackward",key:"s",keyCode:83},{name:"turnLeft",key:"ArrowLeft",keyCode:37},{name:"turnRight",key:"ArrowRight",keyCode:39},{name:"turnLeft",key:"a",keyCode:65},{name:"turnRight",key:"d",keyCode:68},{name:"lookUp",key:"ArrowUp",keyCode:38},{name:"lookDown",key:"ArrowDown",keyCode:40},{name:"grabReleaseObject",key:" ",keyCode:32}]}return r()(e,[{key:"init",value:function(){this.bindKeys(),this.psiturk.handleRecordTrialData("TEST","simInitialized",{config:window.config}),this.initialized=!0,this.initPhysics()}},{key:"initPhysics",value:function(){var e=this;this.activeActions=[],this.activeActionIdx=0,this.frameCounter=0,this.numRendersSinceLastUpdate=0,this.frameCounter=0,this.frameRate=20,Module.enablePhysics&&!0!==window.config.runFlythrough&&(console.log("enabled physics step at 100ms interval"),this.physicsStepFunction=setInterval((function(){var t=e.popAction();"noOp"!=t&&e.handleAction(t);var n=1/e.frameRate,i=(new Date).getTime();e.sim.stepWorld(n),e.render();var o=e.sim.getAgentPose(),s=e.sim.getObjectStates(),r=e.sim.getObjectUnderCrosshair().nearestObjectId,a=[];-1!=e.sim.grippedObjectId&&(a=e.sim.findObjectFloorPositionUnderCrosshair().newObjectPosition,a=e.sim.convertVector3ToVec3f(a)),e.psiturk.handleRecordTrialData("TEST","stepPhysics",{step:n,agentState:o,objectStates:s,objectUnderCrosshair:r,objectDropPoint:a,totalTime:(new Date).getTime()-i}),e.frameCounter+=1}),1e3/this.frameRate))}},{key:"disablePhysics",value:function(){this.physicsStepFunction&&(console.log("clearing physics interval on reset"),window.clearInterval(this.physicsStepFunction))}},{key:"reset",value:function(){this.lastInteractedObjectId=-1,this.disablePhysics(),this.sim.reset(),this.inventory.reset(),this.inventory.renderInventory(),this.setStatus("Ready"),this.initPhysics(),this.render()}},{key:"setTaskValidator",value:function(e){this.taskValidator=new P(e,this.sim)}},{key:"setStatus",value:function(e){this.components.status.style="color:white",this.components.status.innerHTML=e}},{key:"setErrorStatus",value:function(e){this.components.status.style="color:red",this.components.status.innerHTML=e}},{key:"setWarningStatus",value:function(e){this.components.status.style="color:orange",this.components.status.innerHTML=e}},{key:"setSuccessStatus",value:function(e){this.components.status.style="color:green",this.components.status.innerHTML=e}},{key:"renderImage",value:function(){this.sim.displayObservation("rgb")}},{key:"render",value:function(){this.renderImage(),this.sim.updateCrossHairNode(this.sim.getCrosshairPosition()),this.sim.drawBBAroundNearestObject(),this.sim.showDropPoint(),this.renderImage(),this.numRendersSinceLastUpdate+=1}},{key:"handleInventoryUpdate",value:function(e){var t=this.sim.grippedObjectId;if(e)this.setStatus("Collision while releasing object!");else{if(-1==t){var n=this.inventory.findObjectSlot(this.lastInteractedObjectId);-1!=n&&this.inventory.setSlot(n,void 0)}else{var i=this.inventory.getEmptySlot(),o=this.sim.getObjectFromScene(t);-1==i?console.log("No empty slot in inventory!"):this.inventory.setSlot(i,{objectId:t,object:o.object,objectIcon:o.objectIcon})}this.lastInteractedObjectId=t}}},{key:"validateTask",value:function(){return!window.config.runFlythrough&&this.taskValidator.validate()}},{key:"pushAction",value:function(e){0==this.activeActions.length&&this.activeActions.push(e)}},{key:"popAction",value:function(){if(this.activeActions.length>0){this.activeActionIdx=0;var e=this.activeActions[this.activeActionIdx];return"grabReleaseObject"==e&&this.removeActiveAction(e),e}return"noOp"}},{key:"handleAction",value:function(e){var t=!1;if("grabReleaseObject"==e){var n=this.sim.inventoryGrabReleaseObject();if(this.handleInventoryUpdate(n.collision),this.inventory.renderInventory(),1==n.actionFailed)return void this.setErrorStatus("Release action failed")}else t=this.sim.step(e,!0);var i={action:e,agentState:this.sim.getAgentPose()},o=this.sim.getObjectStates(),s=this.sim.getObjectUnderCrosshair().nearestObjectId,r=[];-1!=this.sim.grippedObjectId&&(r=this.sim.findObjectFloorPositionUnderCrosshair().newObjectPosition,r=this.sim.convertVector3ToVec3f(r)),i.objectUnderCrosshair=s,i.nearestObjectId=this.sim.nearestObjectId,i.grippedObjectId=this.sim.grippedObjectId,i.objectDropPoint=r,i.objectStates=o,i.collision=t,this.psiturk.handleRecordTrialData("TEST","handleAction",i)}},{key:"removeActiveAction",value:function(e){var t=this.activeActions.indexOf(e);t>-1&&this.activeActions.splice(t,1)}},{key:"handleKeypressUp",value:function(e){var t,n=L(this.actions);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(i.keyCode===e){this.removeActiveAction(i.name);break}}}catch(e){n.e(e)}finally{n.f()}}},{key:"handleKeypress",value:function(e){var t,n=L(this.actions);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(i.keyCode===e){this.pushAction(i.name);break}}}catch(e){n.e(e)}finally{n.f()}}},{key:"bindKeys",value:function(){var e=this;e.keyBindListener?console.log("Keys already bound. Returning"):(e.keyBindListener=function(t){t.preventDefault(),e.handleKeypress(t.keyCode)},document.addEventListener("keydown",e.keyBindListener,!0),e.keyBindListener2=function(t){t.preventDefault(),e.handleKeypressUp(t.keyCode)},document.addEventListener("keyup",e.keyBindListener2,!0))}},{key:"unbindKeys",value:function(){this.keyBindListener&&(document.removeEventListener("keydown",this.keyBindListener,!0),this.keyBindListener=null,document.removeEventListener("keyup",this.keyBindListener2,!0),this.keyBindListener2=null)}}]),e}();function N(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function H(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?N(Object(n),!0).forEach((function(t){c()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):N(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var U=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"canvas";o()(this,e),c()(this,"currentResolution",d),this.canvasId=t}return r()(e,[{key:"initializeModules",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:u;this.config=new Module.SimulatorConfiguration,this.config.allowSliding=!1,"objectnav"!=window.config.dataset&&(this.config.allowSliding=!0),this.config.scene_id=Module.scene,this.config.enablePhysics=Module.enablePhysics,this.config.physicsConfigFile=Module.physicsConfigFile,this.simenv=new x(this.config,t,0),this.task_type=t.task.type,e=this.updateAgentConfigWithSensors(H({},e)),this.simenv.addAgent(e),this.simenv.updateCrossHairNode(this.simenv.resolution),this.canvasElement=document.getElementById(this.canvasId),this.taskValidator=new P(t,this.simenv),this.task=this.instantiateTask(window.config.dataset)}},{key:"instantiateTask",value:function(e){var t=null;return"objectnav"==e?t=new F(this.simenv,{canvas:this.canvasElement,fps:document.getElementById("fps"),scope:document.getElementById("scope"),status:document.getElementById("status"),taskValidator:this.taskValidator}):"pick_and_place"==e&&(t=new D(this.simenv,{canvas:this.canvasElement,fps:document.getElementById("fps"),inventory:document.getElementById("inventory"),scope:document.getElementById("scope"),status:document.getElementById("status"),taskValidator:this.taskValidator})),t}},{key:"setEpisode",value:function(e){var t=document.getElementById("task-instruction"),n=document.getElementById("text-assistance-1");if(null!=t&&(t.innerHTML="<hr> <h4>Task: "+e.task.instruction+"</h4> <hr>"),null!=n){var i=function(e){if(null==e.objects)return{objects:[],receptacles:[]};for(var t=e.objects,n={objects:[],receptacles:[]},i=0;i<t.length;i++){var o=t[i],s=o.object;s=s.charAt(0).toUpperCase()+s.slice(1);var r="<div><img src='"+o.objectIcon+"' style='border: 3px solid grey'/><div class='img-caption'>"+s+"</div></div>";o.isReceptacle?n.receptacles.push(r):n.objects.push(r)}return n}(e);i.objects.length>0&&i.receptacles.length>0&&"arrangement"==e.task.type&&(n.innerHTML="<div class='object-type'> Object: </div> <ul>"+i.objects.join("\n")+"</ul><br/><div class='object-type'> Receptacle: </div> <ul>"+i.receptacles.join("\n")+"</ul>"),i.objects.length>0&&"cleaning"==e.task.type&&(n.innerHTML="<div class='object-type'> Objects: </div> <ul>"+i.objects.join("\n")+"</ul>")}this.simenv.setEpisode(e)}},{key:"setTaskValidator",value:function(e){this.task.setTaskValidator(e)}},{key:"runFlythrough",value:function(){window.config.disableLogging=!0,window.config.runFlythrough=!0,window.config.actualTask=!1,this.task.reset()}},{key:"runInit",value:function(){window.config.disableLogging=!1,window.config.runFlythrough=!1,window.config.actualTask=!0;var e=window.config.episodeId,t=I("/data/".concat(window.config.taskConfig.name),e,window.config.dataset);this.setEpisode(t),this.setTaskValidator(t),this.task.reset()}},{key:"runTrainingTask",value:function(){window.config.disableLogging=!0,window.config.runFlythrough=!1,window.config.actualTask=!1;var e=window.config.taskConfig.trainingTask.name,t=I("/data/".concat(e),0,window.config.dataset);this.setEpisode(t),this.setTaskValidator(t),this.task.reset()}},{key:"updateAgentConfigWithSensors",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l,t=p.rearrangement;"objectnav"==window.config.dataset&&(t=p[window.config.dataset]);var n=[{uuid:"rgb",sensorType:Module.SensorType.COLOR,position:t.sensorConfig.position,hfov:79,resolution:[480,640]}],i=new Module.ActionSpace,o=new Module.MapStringFloat;o.set("amount",t.actuationSpec.move);var s=new Module.MapStringFloat;s.set("amount",t.actuationSpec.turn);var r=t.actions;for(var a in r)(a=r[a]).includes("move")?i.set(a,new Module.ActionSpec(a,o)):i.set(a,new Module.ActionSpec(a,s));return e.sensorSpecifications=n,e.actionSpace=i,e=this.updateAgentConfigWithResolution(e)}},{key:"resetCanvas",value:function(e){this.canvasElement.width=e.width,this.canvasElement.height=e.height}},{key:"updateAgentConfigWithResolution",value:function(e){var t=this;return e.sensorSpecifications.forEach((function(e){e.resolution=[t.currentResolution.height,t.currentResolution.width]})),e}},{key:"display",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=w();n.useDefaultEpisode&&(t=u),this.initializeModules(e,t),this.task.init(),this.task.reset()}},{key:"validateTask",value:function(){this.task.validateTask()}}]),e}();n(10);function z(e){var t=e;if(0===e.indexOf("http")){var n=e.split("/");t=n[n.length-1]}return"objectnav"==window.config.dataset&&(e=e.includes("semantic")?e.split(".")[0].split("_")[0]+"/"+e:e.split(".")[0]+"/"+e),FS.createPreloadedFile("/",t,"data/scenes/".concat(e),!0,!1),t}Module.preRun.push((function(){for(var e=decodeURIComponent(window.location.search.substr(1)).trim().split("&"),t=0;t!=e.length;++t){var n=e[t].indexOf("=");-1!=n?(Module.arguments.push("--"+e[t].substring(0,n)),Module.arguments.push(e[t].substring(n+1))):Module.arguments.push("--"+e[t])}var i={};i.scene=h,w(i),window.config=i;var o=function(e,t){return console.log("task home: data/tasks/"),"pick_and_place"==t?"data/tasks/pick_and_place/"+e+".json":"objectnav"==t?"data/tasks/objectnav_mp3d_v6/"+e+".json":"data/tasks/"+e+".json"}(i.scene.split(".")[0],window.config.dataset);window.config.datasetPath=o;var s=i.episodeId,r=function(e,t,n){var i=[];if("objectnav"==n){var o=e.scene_state;if(null==o)return[];for(var s in o.objects){var r=o.objects[s].object_template.split("/"),a=r[r.length-1],c=T(a.split(".")[0],a);i.push(c)}for(var l in(o=t.scene_state).objects){var u=o.objects[l].object_template.split("/"),d=u[u.length-1],h=T(d.split(".")[0],d);i.push(h)}}else{var f=e.objects,v=[];for(var p in f){var g=f[p].objectHandle.split("/"),y=g[g.length-1];if(!v.includes(y)){var b=T(y.split(".")[0],y);i.push(b),v.push(y)}}for(var m in f=t.objects){var j=f[m].objectHandle.split("/"),k=j[j.length-1];if(!v.includes(k)){var w=T(k.split(".")[0],k);i.push(w),v.push(k)}}}return i}(A(o,s),A(o,0),window.config.dataset),a=i.scene;Module.scene=z(a);var c=window.config.defaultPhysConfig;Module.physicsConfigFile=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i="/data";FS.mkdir(i);var o=e;if(0===e.indexOf("http")){var s=e.split("/");o=s[s.length-1]}FS.createPreloadedFile(i,o,"data/".concat(e),!0,!1);var r=i.concat("/objects");for(var a in FS.mkdir(r),n){var c=n[a].physicsProperties,l=c.split("/")[c.split("/").length-1],u=n[a].renderMesh,d=u.split("/")[u.split("/").length-1];FS.createPreloadedFile(r,d,"data/".concat(u),!0,!1),FS.createPreloadedFile(r,l,"data/".concat(c),!0,!1)}return i.concat("/".concat(o))}(c,s,r),Module.enablePhysics="true"===window.config.enablePhysics,window.config.runFlythrough="true"===window.config.runFlythrough,function(e){if(void 0!==e){var t=e.split("/"),n=t[t.length-1];FS.createPreloadedFile("/data",n,e,!0,!1)}}(o);var l=a.substr(0,a.lastIndexOf("."));window.config.recomputeNavMesh||(z(l+".navmesh"),z(l+".stage_config.json")),"mp3d"===i.semantic?(z(l+".house"),z(l+"_semantic.ply")):"replica"===i.semantic&&z(function(e){var t=e.split("/"),n=t.length>1;t.pop();var i="info_semantic.json";return n&&(i="/"+i),t.join("/")+i}(i.scene))})),Module.onRuntimeInitialized=function(){var e;if(console.log("hsim_bindings initialized"),e=new U,void 0!==window.config.datasetPath){var t=window.config.scene.split(".")[0],n=I("/data/".concat(t+".json"),window.config.episodeId,window.config.dataset);e.display(void 0,n)}else e.display();!0===window.config.runFlythrough&&e.runFlythrough(),window.demo=e},function(){var e=function(){var e,t,n=!1;try{t=(e=document.createElement("canvas")).getContext("webgl")||e.getContext("experimental-webgl")}catch(e){return}return void 0!==t&&(n=!0),e=void 0,n?2:"undefined"!=typeof WebGL2RenderingContext?1:0}(),t="";if(e?1===e&&(t="WebGL2 is supported on your browser, but not enabled. "):t="WebGL2 is not supported on your browser. ",function(){try{if("object"===("undefined"==typeof WebAssembly?"undefined":m()(WebAssembly))&&"function"==typeof WebAssembly.instantiate){var e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){return!1}return!1}()||(t+="Web Assembly is not supported in your browser"),t.length>0){var n=document.getElementById("warning");n.innerHTML=t,n.className=""}}()}]);
//# sourceMappingURL=bundle.js.map